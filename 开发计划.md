# ReceiptName MVP开发计划

## MVP核心理念

**最小可行产品（MVP）**：快速验证核心价值假设，用最少的功能实现用户价值。

### 核心价值假设
- 用户需要自动识别交易记录图片
- 用户希望根据金额重命名文件
- 火山引擎OCR服务能满足识别需求

## MVP功能范围

### ✅ 核心功能（必须实现）
1. **图片扫描** - 扫描当前目录下的图片文件
2. **OCR识别** - 使用火山引擎提取图片文字 ✅
3. **交易判断** - 识别微信支付、支付宝交易记录 ✅
4. **金额提取** - 提取交易金额 ✅
5. **文件重命名** - 重命名为"金额_支付凭证"格式

### ❌ 非MVP功能（暂不实现）
- 图形界面
- 批量文件夹处理
- 交易记录导出
- 处理历史记录
- 复杂的错误处理

## 开发阶段（2周完成）

### 第一周：基础功能实现

#### Day 1-2: 环境搭建 ✅
- [x] 项目结构创建
- [x] 依赖配置（uv + pyproject.toml）
- [x] 火山引擎API配置
- [x] 基础测试环境
- [x] 代码质量工具配置（black, isort, mypy, ruff）
- [x] 打包配置（PyInstaller）

#### Day 3-4: OCR服务集成 ✅
- [x] 创建 `ocr_service.py`
- [x] 实现火山引擎ARK调用
- [x] 图片预处理功能
- [x] 基础错误处理
- [x] 结构化输出支持
- [x] 重试机制
- [x] 批量处理功能

#### Day 5-7: 核心逻辑开发 ✅
- [x] 创建 `receipt_detector.py`
- [x] 实现交易记录识别
- [x] 实现金额提取
- [x] 创建 `models.py` 并定义 `ReceiptInfo` 模型
- [x] 创建 `file_renamer.py`

### 第二周：集成与测试

#### Day 8-10: 主程序集成
- [ ] 更新 `main.py`
- [ ] 实现文件扫描逻辑
- [ ] 集成所有模块
- [ ] 基础用户交互

#### Day 11-14: 测试与优化
- [ ] 功能测试
- [ ] 错误处理完善
- [ ] 性能优化
- [ ] 文档更新

## 技术实现

### 项目结构（当前状态）
```
ReceiptName/
├── main.py                 # 主程序入口 ✅
├── config.py               # 配置管理 ✅
├── ocr_service.py          # OCR服务 ✅
├── models.py               # 数据模型 ✅
├── receipt_detector.py     # 交易记录检测 ✅
├── test_ocr.py             # OCR测试脚本 ✅
├── file_renamer.py         # 文件重命名 ✅
├── pyproject.toml          # 项目配置 ✅
├── README.md              # 项目文档 ✅
├── env.example            # 环境变量示例 ✅
├── pyinstaller_config.spec # 打包配置 ✅
├── test_image.jpeg        # 测试图片 ✅
└── 示例代码/              # 火山引擎示例 ✅
    ├── 大模型快速入门.md
    ├── 大模型Base64 编码输入.md
    └── 大模型结构化输出.md
```

### 已完成的核心模块

#### 配置管理模块（config.py）✅
```python
class Config:
    """配置管理类"""
    def __init__(self):
        self._load_env_file()
    
    def validate(self) -> bool:
        """验证必要的配置项"""
        # 验证 ARK_API_KEY 和 ARK_MODEL_ID
        pass
    
    def print_config(self):
        """打印当前配置（隐藏敏感信息）"""
        pass
```

#### 主程序入口（main.py）✅
```python
def main():
    """主程序入口"""
    # 验证配置
    if not config.validate():
        return
    
    # 显示当前配置
    config.print_config()
    
    print("✅ 配置就绪，准备进行下一步开发...")
```

#### OCR服务模块（ocr_service.py）✅
```python
class OCRService:
    """OCR服务类"""
    def recognize_receipt(self, image_path: Path) -> ReceiptInfo:
        """识别交易记录图片"""
        # 使用火山引擎方舟API进行图片识别
        # 支持Base64编码输入和结构化输出
        # 包含重试机制和错误处理
        pass
    
    def batch_recognize(self, image_paths: List[Path]) -> Dict[Path, ReceiptInfo]:
        """批量识别图片"""
        pass
```

#### 交易记录信息结构（ReceiptInfo）✅
```python
class ReceiptInfo(BaseModel):
    """交易记录信息结构"""
    is_receipt: bool = Field(description="是否为交易记录")
    platform: Optional[str] = Field(description="支付平台")
    amount: Optional[float] = Field(description="交易金额（元）")
    currency: str = Field(description="货币单位", default="元")
    transaction_time: Optional[str] = Field(description="交易时间")
    merchant: Optional[str] = Field(description="商户名称")
    confidence: float = Field(description="识别置信度（0-1）")
    raw_text: str = Field(description="识别的原始文本")
```

#### 文件重命名模块（file_renamer.py）✅
```python
class FileRenamer:
    """文件重命名器"""
    def generate_new_filename(self, receipt_info: ReceiptInfo, original_filename: str) -> str:
        """根据交易记录信息生成新的文件名"""
        # 格式：金额_平台_支付凭证_时间戳.扩展名
        pass
    
    def rename_file(self, original_path: Path, receipt_info: ReceiptInfo) -> Optional[Path]:
        """重命名单个文件"""
        pass
    
    def batch_rename(self, rename_tasks: Dict[Path, ReceiptInfo]) -> Dict[Path, Optional[Path]]:
        """批量重命名文件"""
        pass
    
    def get_supported_image_files(self, directory: Optional[Path] = None) -> List[Path]:
        """获取目录中支持的图片文件列表"""
        pass
```

### 待实现的核心算法

#### 交易记录识别
```python
def is_receipt(text: str) -> bool:
    """判断文本是否为交易记录"""
    keywords = ['微信支付', '支付宝', '交易成功', '支付成功']
    return any(keyword in text for keyword in keywords)
```

#### 金额提取
```python
def extract_amount(text: str) -> Optional[float]:
    """提取金额"""
    import re
    # 匹配数字金额模式
    pattern = r'(\d+\.?\d*)\s*元'
    match = re.search(pattern, text)
    return float(match.group(1)) if match else None
```

## 成功标准

### MVP验证指标
1. **功能完整性** - 能够识别并重命名交易记录
2. **准确性** - 识别准确率 > 80%
3. **易用性** - 用户能在5分钟内完成配置和使用
4. **稳定性** - 基本错误处理，不会崩溃

### 用户反馈收集
- 识别准确率如何？
- 使用过程是否顺畅？
- 是否解决了文件管理问题？
- 还需要什么功能？

## 风险评估

### 技术风险
- **OCR识别准确率低** → 优化关键词匹配
- **API调用失败** → 实现重试机制
- **文件重命名冲突** → 添加序号后缀

### 时间风险
- **开发进度延迟** → 简化功能，专注核心
- **测试时间不足** → 重点测试核心流程

## 当前进度

### ✅ 已完成（Day 1-4）
- [x] 项目基础架构搭建
- [x] 依赖管理和配置（uv + pyproject.toml）
- [x] 配置管理模块（config.py）
- [x] 环境变量验证和加载
- [x] 代码质量工具配置
- [x] 测试框架配置
- [x] 打包配置（PyInstaller）
- [x] 基础文档和示例代码
- [x] OCR服务集成（ocr_service.py）
- [x] 火山引擎方舟API调用
- [x] Base64编码图片输入
- [x] 结构化输出支持
- [x] 重试机制和错误处理
- [x] 批量处理功能
- [x] OCR测试脚本（test_ocr.py）
- [x] 测试图片准备
- [x] 创建 `models.py` 并定义 `ReceiptInfo` 模型
- [x] 交易记录识别模块（receipt_detector.py）

### ✅ 已完成阶段（Day 5-7）
- [x] 文件重命名功能（file_renamer.py）
- [x] 完整的核心模块开发

### 🔄 当前阶段（Day 8-10）
- [ ] 主程序集成和文件扫描逻辑
- [ ] 集成所有模块到主程序
- [ ] 实现完整的文件处理流程

### 📋 下一步计划
- [ ] 更新 main.py 集成所有功能
- [ ] 实现完整的自动化处理流程
- [ ] 功能测试和优化
- [ ] 用户交互完善

## 技术亮点

### 已实现的核心技术
1. **结构化输出** - 使用Pydantic模型确保OCR结果的一致性
2. **重试机制** - 自动处理API调用失败的情况
3. **批量处理** - 支持多图片同时处理
4. **错误处理** - 完善的异常处理和日志记录
5. **配置管理** - 灵活的环境变量配置系统

### 测试覆盖
- [x] 配置验证测试
- [x] OCR服务初始化测试
- [x] 图片处理功能测试
- [x] 实际图片识别测试

## 后续规划

### 基于MVP反馈的功能扩展
1. **用户反馈分析** - 收集使用数据和反馈
2. **功能优先级排序** - 根据用户需求调整
3. **迭代开发** - 逐步添加有价值的功能

### 可能的扩展方向
- 支持更多交易类型
- 批量文件夹处理
- 图形界面
- 处理进度显示
- 历史记录管理

## 开发原则

### MVP开发原则
1. **快速验证** - 优先实现核心价值
2. **简单优先** - 避免过度设计
3. **用户导向** - 基于实际需求开发
4. **迭代改进** - 根据反馈持续优化

### 代码质量
- 基本错误处理
- 清晰的函数命名
- 必要的注释
- 简单的测试覆盖

---

**开发周期**: 2周  
**团队规模**: 1-2人  
**项目状态**: MVP开发中（Day 5-7）  
**目标**: 快速验证核心价值假设  
**当前进度**: 基础架构完成，开始交易记录识别 